<!--
Notion-dark Personal Finance Dashboard (50/30/20)
Host-ready for GitHub Pages. Single-file, offline-first, uses localStorage.

How to use:
1) Save this as: index.html
2) Commit to a GitHub repo (e.g., /docs or root), enable GitHub Pages
3) Open your site, fill in month + numbers, click "Save month"

Data:
- Stored in your browser (localStorage) on that device.
- Use Export/Import to move backups between devices/browsers.

-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finance Dashboard</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg: #0f1115;
      --panel: #151922;
      --panel-2: #111520;
      --border: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.88);
      --muted: rgba(255,255,255,.62);
      --faint: rgba(255,255,255,.40);
      --accent: #6aa9ff;
      --good: #7ee787;
      --warn: #ffd36a;
      --bad: #ff7b72;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --radius-sm: 10px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(106,169,255,.10), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(126,231,135,.07), transparent 55%),
                  var(--bg);
      color: var(--text);
      letter-spacing: .1px;
    }
    a{color: var(--accent); text-decoration: none}
    a:hover{text-decoration: underline}
    .wrap{
      max-width: 1180px;
      margin: 28px auto 60px;
      padding: 0 18px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 16px;
      margin-bottom: 18px;
    }
    .title{
      display:flex; flex-direction:column; gap:6px;
    }
    .title h1{
      margin:0;
      font-size: 20px;
      font-weight: 650;
      letter-spacing: .2px;
    }
    .title p{ margin:0; color: var(--muted); font-size: 13px; line-height: 1.35; }
    .top-actions{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:flex-end;
    }
    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 9px 11px;
      border-radius: 10px;
      font-size: 13px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.12); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(106,169,255,.35);
      background: rgba(106,169,255,.12);
    }
    .btn.primary:hover{ background: rgba(106,169,255,.18); }
    .btn.danger{
      border-color: rgba(255,123,114,.30);
      background: rgba(255,123,114,.10);
    }
    .btn.danger:hover{ background: rgba(255,123,114,.16); }
    input[type="file"]{ display:none; }
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.08);
    }
    .card .hd h2{
      margin:0;
      font-size: 14px;
      font-weight: 650;
      color: rgba(255,255,255,.90);
    }
    .card .hd .sub{
      font-size: 12px;
      color: var(--muted);
      margin-left: 8px;
      font-weight: 500;
    }
    .card .bd{
      padding: 14px 16px 16px;
    }
    .kpis{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin: 12px 0 14px;
    }
    @media (max-width: 980px){
      .kpis{ grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 560px){
      .kpis{ grid-template-columns: repeat(2, 1fr); }
    }
    .kpi{
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
      border-radius: 12px;
      padding: 10px 10px 9px;
      min-height: 66px;
    }
    .kpi .label{
      font-size: 11px;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .pill{
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.78);
      background: rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .pill.good{ border-color: rgba(126,231,135,.35); color: rgba(126,231,135,.95); background: rgba(126,231,135,.08); }
    .pill.warn{ border-color: rgba(255,211,106,.35); color: rgba(255,211,106,.95); background: rgba(255,211,106,.08); }
    .pill.bad{ border-color: rgba(255,123,114,.35); color: rgba(255,123,114,.95); background: rgba(255,123,114,.08); }

    .kpi .value{
      margin-top: 6px;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .kpi .hint{
      margin-top: 2px;
      font-size: 11px;
      color: var(--faint);
    }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .form{ grid-template-columns: 1fr; }
    }
    .field{
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 12px;
      padding: 10px 10px;
      background: rgba(0,0,0,.10);
    }
    .field label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .field input, .field select{
      width:100%;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 10px;
      font-size: 14px;
      outline:none;
    }
    .field input:focus, .field select:focus{
      border-color: rgba(106,169,255,.35);
      box-shadow: 0 0 0 3px rgba(106,169,255,.14);
    }

    .section{
      margin-top: 14px;
      border-top: 1px solid rgba(255,255,255,.06);
      padding-top: 14px;
    }
    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .section-title h3{
      margin:0;
      font-size: 13px;
      font-weight: 650;
      color: rgba(255,255,255,.86);
    }
    .section-title small{ color: var(--muted); }

    .bills{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .bill-row{
      display:grid;
      grid-template-columns: 1.1fr .8fr auto;
      gap: 10px;
      align-items:center;
    }
    @media (max-width: 560px){
      .bill-row{ grid-template-columns: 1fr 1fr auto; }
    }
    .bill-row input{
      width:100%;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 13px;
      outline:none;
    }
    .icon-btn{
      width: 36px; height: 36px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.80);
      cursor:pointer;
    }
    .icon-btn:hover{ background: rgba(255,255,255,.06); }
    .icon-btn:active{ transform: translateY(1px); }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .split{ grid-template-columns: 1fr; }
    }
    .canvas-wrap{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    canvas{
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
      border-radius: 12px;
      width: 100%;
      max-width: 420px;
      height: 220px;
    }
    .legend{
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-width: 260px;
      flex: 1;
    }
    .legend-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
      font-size: 13px;
    }
    .dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.25);
      margin-right: 10px;
    }
    .left{
      display:flex; align-items:center; gap: 10px;
      color: rgba(255,255,255,.85);
      font-weight: 600;
    }
    .right{
      display:flex; flex-direction:column; align-items:flex-end; gap:2px;
      min-width: 120px;
    }
    .right .pct{ font-family: var(--mono); font-size: 12px; color: rgba(255,255,255,.70); }
    .right .amt{ font-weight: 700; }

    .msg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.07);
      background: rgba(0,0,0,.10);
      color: rgba(255,255,255,.80);
      font-size: 13px;
      line-height: 1.35;
    }
    .msg strong{ color: rgba(255,255,255,.92); }
    .msg.good{ border-color: rgba(126,231,135,.22); background: rgba(126,231,135,.06); }
    .msg.warn{ border-color: rgba(255,211,106,.22); background: rgba(255,211,106,.06); }
    .msg.bad{ border-color: rgba(255,123,114,.22); background: rgba(255,123,114,.06); }

    .progress{
      height: 10px;
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.08);
    }
    .progress > div{
      height:100%;
      width: 0%;
      background: rgba(106,169,255,.55);
    }
    .goal-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .goal-grid{ grid-template-columns: 1fr; }
    }
    .goal{
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
      border-radius: 12px;
      padding: 10px 10px 12px;
    }
    .goal .row{
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }
    .goal .name{
      font-weight: 650; font-size: 13px; color: rgba(255,255,255,.88);
    }
    .goal .meta{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.65);
    }
    .goal .small{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.35;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      overflow:hidden;
      border-radius: 12px;
    }
    thead th{
      text-align:left;
      font-size: 11px;
      color: var(--muted);
      font-weight: 650;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
    }
    tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      color: rgba(255,255,255,.82);
      vertical-align: middle;
    }
    tbody tr:hover{ background: rgba(255,255,255,.03); }
    .mono{ font-family: var(--mono); }
    .row-actions{
      display:flex; gap: 10px; flex-wrap:wrap; align-items:center;
    }
    .hintline{
      margin-top: 10px;
      color: var(--faint);
      font-size: 12px;
      line-height: 1.4;
    }
    .footer{
      margin-top: 16px;
      color: var(--faint);
      font-size: 12px;
      line-height: 1.5;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.75);
      font-size: 12px;
      user-select:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Finance Dashboard</h1>
        <p>Monthly wage + bills + 50/30/20 allocations. No transaction tracking ‚Äî everything else becomes <b>spare cash</b>.</p>
      </div>

      <div class="top-actions">
        <span class="badge" id="storageBadge">Local: OK</span>
        <button class="btn primary" id="saveMonthBtn">Save month</button>
        <button class="btn" id="exportBtn">Export backup</button>
        <label class="btn" for="importFile">Import backup</label>
        <input id="importFile" type="file" accept="application/json" />
        <button class="btn danger" id="resetBtn" title="Clears local data on this browser only">Reset local data</button>
      </div>
    </header>

    <div class="kpis" id="kpis">
      <!-- filled by JS -->
    </div>

    <div class="grid">
      <!-- Left: Input + Bills -->
      <section class="card">
        <div class="hd">
          <div>
            <h2>Monthly inputs <span class="sub">edit once per month</span></h2>
          </div>
          <div class="row-actions">
            <button class="btn" id="loadMonthBtn">Load saved month</button>
          </div>
        </div>
        <div class="bd">
          <div class="form">
            <div class="field">
              <label>
                Month
                <span class="pill" id="monthSavedPill">Not saved</span>
              </label>
              <input id="monthInput" type="month" />
            </div>

            <div class="field">
              <label>Net wage (income)</label>
              <input id="incomeInput" type="number" step="0.01" min="0" placeholder="e.g. 2600" />
            </div>

            <div class="field">
              <label>Savings contribution</label>
              <input id="savingsInput" type="number" step="0.01" min="0" placeholder="e.g. 300" />
            </div>

            <div class="field">
              <label>Investing contribution</label>
              <input id="investInput" type="number" step="0.01" min="0" placeholder="e.g. 200" />
            </div>

            <div class="field">
              <label>Savings goal target (optional)</label>
              <input id="savingsGoalTarget" type="number" step="0.01" min="0" placeholder="e.g. 5000" />
            </div>

            <div class="field">
              <label>Current savings total (optional)</label>
              <input id="savingsGoalCurrent" type="number" step="0.01" min="0" placeholder="e.g. 2100" />
            </div>
          </div>

          <div class="section">
            <div class="section-title">
              <h3>Bills (fixed / recurring)</h3>
              <div class="row-actions">
                <button class="btn" id="addBillBtn">Add bill</button>
              </div>
            </div>
            <div class="bills" id="billsList"></div>
            <div class="hintline">Tip: keep bills as ‚ÄúNeeds‚Äù. Everything not entered becomes ‚ÄúWants / Spare cash‚Äù.</div>
          </div>
        </div>
      </section>

      <!-- Right: 50/30/20 + Safety + Goals -->
      <section class="card">
        <div class="hd">
          <h2>Rule tracking</h2>
          <span class="pill" id="gradePill">‚Äî</span>
        </div>
        <div class="bd">

          <div class="canvas-wrap">
            <canvas id="pie" width="520" height="280" aria-label="Allocation pie chart"></canvas>
            <div class="legend" id="legend"></div>
          </div>

          <div class="msg" id="ruleMsg"></div>

          <div class="section">
            <div class="section-title">
              <h3>Bills safety</h3>
              <small>quick stress check</small>
            </div>
            <div class="msg" id="safetyMsg"></div>
          </div>

          <div class="section">
            <div class="section-title">
              <h3>Goals</h3>
              <small>savings progress + investing projection</small>
            </div>

            <div class="goal-grid">
              <div class="goal">
                <div class="row">
                  <div class="name">Savings goal</div>
                  <div class="meta" id="savingsGoalMeta">‚Äî</div>
                </div>
                <div style="margin-top:10px" class="progress"><div id="savingsGoalBar"></div></div>
                <div class="small" id="savingsGoalText">Set a target + current total to track progress.</div>
              </div>

              <div class="goal">
                <div class="row">
                  <div class="name">Investing projection</div>
                  <div class="meta" id="investMeta">‚Äî</div>
                </div>
                <div class="small" id="investText">Enter your monthly investing contribution to see a simple yearly projection.</div>
              </div>
            </div>

            <div class="footer">
              <span class="mono">50/30/20 mapping:</span> Needs = Bills, Wants = Spare, Future = Savings + Investing.
              <br/>This is an allocation dashboard (not accounting). Export backups if you use multiple devices.
            </div>
          </div>

        </div>
      </section>
    </div>

    <section class="card" style="margin-top:14px">
      <div class="hd">
        <h2>Monthly history</h2>
        <div class="row-actions">
          <button class="btn" id="deleteSelectedBtn">Delete selected</button>
        </div>
      </div>
      <div class="bd">
        <div style="overflow:auto; border-radius: 12px; border: 1px solid rgba(255,255,255,.06);">
          <table>
            <thead>
              <tr>
                <th style="width:36px"></th>
                <th>Month</th>
                <th class="mono">Income</th>
                <th class="mono">Bills</th>
                <th class="mono">Saved</th>
                <th class="mono">Invested</th>
                <th class="mono">Spare</th>
                <th>Needs / Wants / Future</th>
                <th>Grade</th>
              </tr>
            </thead>
            <tbody id="historyBody"></tbody>
          </table>
        </div>
        <div class="hintline">‚ÄúSave month‚Äù stores a snapshot. ‚ÄúLoad saved month‚Äù pulls it back into the form.</div>
      </div>
    </section>
  </div>

  <script>
    (() => {
      "use strict";

      // ---------- Storage ----------
      const STORAGE_KEY = "notion_finance_dashboard_v1";

      /** @typedef {{ id:string, name:string, amount:number }} Bill */
      /** @typedef {{
       *   month: string, // YYYY-MM
       *   income: number,
       *   bills: Bill[],
       *   savings: number,
       *   investing: number,
       *   savingsGoalTarget: number,
       *   savingsGoalCurrent: number,
       *   createdAt: number
       * }} MonthEntry
       */

      const GBP = new Intl.NumberFormat("en-GB", { style: "currency", currency: "GBP" });
      const PCT = (x) => (isFinite(x) ? (x * 100).toFixed(1) + "%" : "‚Äî");

      const $ = (id) => document.getElementById(id);

      // UI refs
      const monthInput = $("monthInput");
      const incomeInput = $("incomeInput");
      const savingsInput = $("savingsInput");
      const investInput = $("investInput");
      const savingsGoalTarget = $("savingsGoalTarget");
      const savingsGoalCurrent = $("savingsGoalCurrent");

      const billsList = $("billsList");
      const addBillBtn = $("addBillBtn");

      const saveMonthBtn = $("saveMonthBtn");
      const loadMonthBtn = $("loadMonthBtn");
      const exportBtn = $("exportBtn");
      const importFile = $("importFile");
      const resetBtn = $("resetBtn");
      const deleteSelectedBtn = $("deleteSelectedBtn");

      const kpisEl = $("kpis");
      const legendEl = $("legend");
      const pie = $("pie");
      const gradePill = $("gradePill");
      const monthSavedPill = $("monthSavedPill");
      const ruleMsg = $("ruleMsg");
      const safetyMsg = $("safetyMsg");
      const historyBody = $("historyBody");
      const storageBadge = $("storageBadge");

      const savingsGoalMeta = $("savingsGoalMeta");
      const savingsGoalBar = $("savingsGoalBar");
      const savingsGoalText = $("savingsGoalText");
      const investMeta = $("investMeta");
      const investText = $("investText");

      // ---------- State ----------
      /** @type {{ billsTemplate: Bill[], history: MonthEntry[] }} */
      let state = loadState();

      // ---------- Defaults ----------
      const defaultBills = [
        { id: cryptoId(), name: "Rent / Mortgage", amount: 0 },
        { id: cryptoId(), name: "Utilities", amount: 0 },
        { id: cryptoId(), name: "Phone / Internet", amount: 0 },
        { id: cryptoId(), name: "Subscriptions", amount: 0 },
        { id: cryptoId(), name: "Insurance", amount: 0 },
        { id: cryptoId(), name: "Transport", amount: 0 },
      ];

      function initMonthToNow() {
        const d = new Date();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yyyy = d.getFullYear();
        monthInput.value = `${yyyy}-${mm}`;
      }

      function ensureTemplate() {
        if (!state.billsTemplate || !Array.isArray(state.billsTemplate) || state.billsTemplate.length === 0) {
          state.billsTemplate = structuredClone(defaultBills);
          saveState();
        }
      }

      // ---------- Helpers ----------
      function cryptoId() {
        if (crypto?.randomUUID) return crypto.randomUUID();
        return "id_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
      }

      function num(v) {
        const x = Number(v);
        return isFinite(x) && x >= 0 ? x : 0;
      }

      function sumBills(bills) {
        return bills.reduce((acc, b) => acc + (isFinite(b.amount) ? b.amount : 0), 0);
      }

      function clamp01(x) {
        return Math.max(0, Math.min(1, x));
      }

      function statusPill(kind, text) {
        return `<span class="pill ${kind}">${escapeHtml(text)}</span>`;
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function findHistory(month) {
        return state.history.find(e => e.month === month) || null;
      }

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        storageBadge.textContent = "Local: OK";
        storageBadge.style.borderColor = "rgba(126,231,135,.35)";
        storageBadge.style.color = "rgba(126,231,135,.95)";
        storageBadge.style.background = "rgba(126,231,135,.08)";
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return { billsTemplate: [], history: [] };
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== "object") return { billsTemplate: [], history: [] };
          parsed.billsTemplate ??= [];
          parsed.history ??= [];
          return parsed;
        } catch {
          return { billsTemplate: [], history: [] };
        }
      }

      function resetState() {
        state = { billsTemplate: structuredClone(defaultBills), history: [] };
        saveState();
        renderAll();
      }

      // ---------- Bills UI ----------
      function renderBills(list) {
        billsList.innerHTML = "";
        list.forEach((bill) => {
          const row = document.createElement("div");
          row.className = "bill-row";
          row.dataset.id = bill.id;

          const name = document.createElement("input");
          name.type = "text";
          name.value = bill.name ?? "";
          name.placeholder = "Bill name";

          const amt = document.createElement("input");
          amt.type = "number";
          amt.step = "0.01";
          amt.min = "0";
          amt.value = isFinite(bill.amount) ? String(bill.amount) : "0";
          amt.placeholder = "0.00";

          const del = document.createElement("button");
          del.className = "icon-btn";
          del.title = "Remove";
          del.textContent = "√ó";

          name.addEventListener("input", () => {
            bill.name = name.value;
            persistTemplateFromUI();
            renderAllLight();
          });
          amt.addEventListener("input", () => {
            bill.amount = num(amt.value);
            persistTemplateFromUI();
            renderAllLight();
          });
          del.addEventListener("click", () => {
            const idx = state.billsTemplate.findIndex(b => b.id === bill.id);
            if (idx >= 0) state.billsTemplate.splice(idx, 1);
            saveState();
            renderAll();
          });

          row.appendChild(name);
          row.appendChild(amt);
          row.appendChild(del);
          billsList.appendChild(row);
        });
      }

      function persistTemplateFromUI() {
        // state.billsTemplate already mutated via references; just save
        saveState();
      }

      function addBill() {
        state.billsTemplate.push({ id: cryptoId(), name: "New bill", amount: 0 });
        saveState();
        renderAll();
      }

      // ---------- Calculations ----------
      function calcFromInputs() {
        const income = num(incomeInput.value);
        const savings = num(savingsInput.value);
        const investing = num(investInput.value);
        const bills = structuredClone(state.billsTemplate).map(b => ({...b, amount: num(b.amount)}));
        const billsTotal = sumBills(bills);

        const future = savings + investing;
        const spare = Math.max(0, income - billsTotal - future);
        const over = income - billsTotal - future; // can be negative

        const needsPct = income > 0 ? billsTotal / income : 0;
        const wantsPct = income > 0 ? spare / income : 0;
        const futurePct = income > 0 ? future / income : 0;

        return {
          income, savings, investing, bills, billsTotal, future, spare, over,
          needsPct, wantsPct, futurePct
        };
      }

      function grade50_30_20(needsPct, wantsPct, futurePct) {
        // Targets: needs <= 0.50, wants <= 0.30, future >= 0.20
        // Score based on distance from target; simple and readable.
        let score = 0;

        // Needs: penalty if above 50%
        score += Math.max(0, (needsPct - 0.50) / 0.20) * 40; // 20% over => +40

        // Wants: penalty if above 30%
        score += Math.max(0, (wantsPct - 0.30) / 0.20) * 30;

        // Future: penalty if below 20%
        score += Math.max(0, (0.20 - futurePct) / 0.20) * 40;

        // If income=0, treat as unknown
        if (!isFinite(needsPct) || !isFinite(wantsPct) || !isFinite(futurePct)) return { grade: "‚Äî", pill: "warn", score: 999 };

        // Map score to grade
        let grade = "A";
        if (score <= 10) grade = "A";
        else if (score <= 25) grade = "B";
        else if (score <= 45) grade = "C";
        else grade = "D";

        const pill = (grade === "A" || grade === "B") ? "good" : (grade === "C" ? "warn" : "bad");
        return { grade, pill, score: Math.round(score) };
      }

      // ---------- Charts ----------
      function drawPie(ctx, w, h, slices) {
        // slices: [{label, value, color}]
        ctx.clearRect(0, 0, w, h);

        // background subtle
        ctx.fillStyle = "rgba(0,0,0,.08)";
        ctx.fillRect(0,0,w,h);

        const total = slices.reduce((a,s) => a + s.value, 0);
        const cx = Math.round(w * 0.38);
        const cy = Math.round(h * 0.52);
        const r  = Math.round(Math.min(w, h) * 0.32);

        // If total == 0, show empty ring
        if (!(total > 0)) {
          ctx.beginPath();
          ctx.arc(cx, cy, r, 0, Math.PI * 2);
          ctx.strokeStyle = "rgba(255,255,255,.10)";
          ctx.lineWidth = 18;
          ctx.stroke();

          ctx.fillStyle = "rgba(255,255,255,.55)";
          ctx.font = "600 13px ui-sans-serif, system-ui";
          ctx.fillText("Enter income to see allocation", Math.round(w*0.12), Math.round(h*0.85));
          return;
        }

        let start = -Math.PI / 2;
        slices.forEach((s) => {
          const angle = (s.value / total) * Math.PI * 2;
          ctx.beginPath();
          ctx.moveTo(cx, cy);
          ctx.arc(cx, cy, r, start, start + angle);
          ctx.closePath();
          ctx.fillStyle = s.color;
          ctx.fill();
          start += angle;
        });

        // inner cutout
        ctx.beginPath();
        ctx.arc(cx, cy, Math.round(r * 0.62), 0, Math.PI * 2);
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue("--panel").trim() || "#151922";
        ctx.fill();

        // center text
        ctx.fillStyle = "rgba(255,255,255,.84)";
        ctx.font = "700 16px ui-sans-serif, system-ui";
        ctx.textAlign = "center";
        ctx.fillText("Allocation", cx, cy - 2);
        ctx.fillStyle = "rgba(255,255,255,.60)";
        ctx.font = "600 12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
        ctx.fillText("Needs ‚Ä¢ Wants ‚Ä¢ Future", cx, cy + 18);
        ctx.textAlign = "start";
      }

      function palette(kind) {
        // Muted, Notion-like
        if (kind === "needs") return "rgba(106,169,255,.55)";
        if (kind === "wants") return "rgba(255,211,106,.50)";
        if (kind === "future") return "rgba(126,231,135,.50)";
        return "rgba(255,255,255,.25)";
      }

      // ---------- Rendering ----------
      function renderKpis(c, gradeObj) {
        const items = [
          { label: "Income", value: GBP.format(c.income), hint: "Net wage", pill: "‚Äî" },
          { label: "Bills", value: GBP.format(c.billsTotal), hint: `${PCT(c.needsPct)} of income`, pill: c.needsPct <= 0.50 ? "good" : (c.needsPct <= 0.60 ? "warn" : "bad") },
          { label: "Savings", value: GBP.format(c.savings), hint: "Future bucket", pill: "‚Äî" },
          { label: "Investing", value: GBP.format(c.investing), hint: "Future bucket", pill: "‚Äî" },
          { label: "Spare cash", value: GBP.format(c.spare), hint: `${PCT(c.wantsPct)} of income`, pill: c.wantsPct <= 0.30 ? "good" : (c.wantsPct <= 0.40 ? "warn" : "bad") },
          { label: "50/30/20 grade", value: gradeObj.grade, hint: `Score: ${gradeObj.score}`, pill: gradeObj.pill },
        ];

        kpisEl.innerHTML = items.map((it) => `
          <div class="kpi">
            <div class="label">
              <span>${escapeHtml(it.label)}</span>
              ${it.pill === "‚Äî" ? "" : statusPill(it.pill, it.pill.toUpperCase())}
            </div>
            <div class="value ${it.label.includes("grade") ? "mono" : ""}">${escapeHtml(it.value)}</div>
            <div class="hint">${escapeHtml(it.hint)}</div>
          </div>
        `).join("");
      }

      function renderLegend(c) {
        const total = c.income > 0 ? c.income : (c.billsTotal + c.future + c.spare);
        const slices = [
          { key:"needs", label:"Needs (Bills)", value: c.billsTotal, pct: total>0 ? c.billsTotal/total : 0, color: palette("needs") },
          { key:"wants", label:"Wants (Spare)", value: c.spare, pct: total>0 ? c.spare/total : 0, color: palette("wants") },
          { key:"future", label:"Future (Save+Invest)", value: c.future, pct: total>0 ? c.future/total : 0, color: palette("future") },
        ];

        legendEl.innerHTML = slices.map(s => `
          <div class="legend-item">
            <div class="left">
              <span class="dot" style="background:${s.color}"></span>
              <span>${escapeHtml(s.label)}</span>
            </div>
            <div class="right">
              <div class="amt">${escapeHtml(GBP.format(s.value))}</div>
              <div class="pct">${escapeHtml(PCT(s.pct))}</div>
            </div>
          </div>
        `).join("");
      }

      function renderGrade(gradeObj) {
        gradePill.className = `pill ${gradeObj.pill}`;
        gradePill.textContent = `Grade ${gradeObj.grade}`;
      }

      function renderMessages(c) {
        const g = grade50_30_20(c.needsPct, c.wantsPct, c.futurePct);

        // Rule message
        let ruleKind = g.pill;
        let msg = "";
        if (c.income <= 0) {
          ruleKind = "warn";
          msg = "<strong>Add your monthly wage</strong> to see your 50/30/20 breakdown.";
        } else if (c.over < 0) {
          ruleKind = "bad";
          msg = `<strong>You‚Äôre over-allocated</strong> by ${escapeHtml(GBP.format(Math.abs(c.over)))}. Reduce bills/savings/investing or increase income.`;
        } else {
          const needsOk = c.needsPct <= 0.50;
          const wantsOk = c.wantsPct <= 0.30;
          const futureOk = c.futurePct >= 0.20;
          const parts = [];
          parts.push(`Needs: <span class="mono">${escapeHtml(PCT(c.needsPct))}</span> (target ‚â§ 50%)`);
          parts.push(`Wants: <span class="mono">${escapeHtml(PCT(c.wantsPct))}</span> (target ‚â§ 30%)`);
          parts.push(`Future: <span class="mono">${escapeHtml(PCT(c.futurePct))}</span> (target ‚â• 20%)`);
          const status = (needsOk && wantsOk && futureOk)
            ? "You‚Äôre following the rule this month."
            : "You‚Äôre off-target ‚Äî tweak allocations.";
          msg = `<strong>${escapeHtml(status)}</strong><br>${parts.join(" ‚Ä¢ ")}`;
        }
        ruleMsg.className = `msg ${ruleKind}`;
        ruleMsg.innerHTML = msg;

        // Safety message (bills stress)
        let sKind = "good";
        let sText = "";
        if (c.income <= 0) {
          sKind = "warn";
          sText = "Enter income to calculate bills safety.";
        } else {
          const afterBills = c.income - c.billsTotal;
          const billsPct = c.billsTotal / c.income;
          if (billsPct <= 0.50) {
            sKind = "good";
            sText = `<strong>Bills look healthy.</strong> Bills are ${escapeHtml(PCT(billsPct))} of income. After bills you have ${escapeHtml(GBP.format(afterBills))}.`;
          } else if (billsPct <= 0.60) {
            sKind = "warn";
            sText = `<strong>Bills are getting heavy.</strong> Bills are ${escapeHtml(PCT(billsPct))} of income. After bills you have ${escapeHtml(GBP.format(afterBills))}.`;
          } else {
            sKind = "bad";
            sText = `<strong>Bills are high risk.</strong> Bills are ${escapeHtml(PCT(billsPct))} of income. Consider cutting fixed costs if possible.`;
          }
        }
        safetyMsg.className = `msg ${sKind}`;
        safetyMsg.innerHTML = sText;
      }

      function renderGoals(c) {
        const target = num(savingsGoalTarget.value);
        const current = num(savingsGoalCurrent.value);

        if (target > 0) {
          const pct = clamp01(current / target);
          savingsGoalMeta.textContent = `${GBP.format(current)} / ${GBP.format(target)}`;
          savingsGoalBar.style.width = (pct * 100).toFixed(1) + "%";

          // Estimate completion date if savingsInput>0
          const monthly = c.savings;
          let est = "";
          if (monthly > 0 && current < target) {
            const remaining = target - current;
            const months = Math.ceil(remaining / monthly);
            const d = new Date();
            d.setMonth(d.getMonth() + months);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            est = ` At ${GBP.format(monthly)}/mo, finish in ~${months} month(s) (${yyyy}-${mm}).`;
          } else if (current >= target) {
            est = " Goal reached üéâ";
          }
          savingsGoalText.textContent = `Progress: ${(pct*100).toFixed(1)}%.${est}`;
        } else {
          savingsGoalMeta.textContent = "‚Äî";
          savingsGoalBar.style.width = "0%";
          savingsGoalText.textContent = "Set a target + current total to track progress.";
        }

        const inv = c.investing;
        if (inv > 0) {
          investMeta.textContent = `${GBP.format(inv)}/mo`;
          investText.textContent = `${GBP.format(inv)} per month ‚Üí ~${GBP.format(inv * 12)} per year (simple projection).`;
        } else {
          investMeta.textContent = "‚Äî";
          investText.textContent = "Enter your monthly investing contribution to see a simple yearly projection.";
        }
      }

      function renderMonthSavedIndicator() {
        const month = monthInput.value;
        const found = findHistory(month);
        if (found) {
          monthSavedPill.className = "pill good";
          monthSavedPill.textContent = "Saved";
        } else {
          monthSavedPill.className = "pill warn";
          monthSavedPill.textContent = "Not saved";
        }
      }

      function renderHistory() {
        const rows = [...state.history].sort((a,b) => a.month.localeCompare(b.month));
        historyBody.innerHTML = rows.map((e) => {
          const billsTotal = sumBills(e.bills || []);
          const future = num(e.savings) + num(e.investing);
          const spare = Math.max(0, num(e.income) - billsTotal - future);

          const needsPct = e.income > 0 ? billsTotal / e.income : 0;
          const wantsPct = e.income > 0 ? spare / e.income : 0;
          const futurePct = e.income > 0 ? future / e.income : 0;
          const g = grade50_30_20(needsPct, wantsPct, futurePct);

          const gradeBadge = `<span class="pill ${g.pill}"> ${g.grade} </span>`;
          const nbf = `${PCT(needsPct)} / ${PCT(wantsPct)} / ${PCT(futurePct)}`;

          return `
            <tr>
              <td><input type="checkbox" data-month="${escapeHtml(e.month)}"/></td>
              <td class="mono">${escapeHtml(e.month)}</td>
              <td class="mono">${escapeHtml(GBP.format(num(e.income)))}</td>
              <td class="mono">${escapeHtml(GBP.format(billsTotal))}</td>
              <td class="mono">${escapeHtml(GBP.format(num(e.savings)))}</td>
              <td class="mono">${escapeHtml(GBP.format(num(e.investing)))}</td>
              <td class="mono">${escapeHtml(GBP.format(spare))}</td>
              <td class="mono">${escapeHtml(nbf)}</td>
              <td>${gradeBadge}</td>
            </tr>
          `;
        }).join("");
      }

      function renderPie(c) {
        const ctx = pie.getContext("2d");
        const w = pie.width, h = pie.height;

        const slices = [
          { label: "Needs", value: c.billsTotal, color: palette("needs") },
          { label: "Wants", value: c.spare, color: palette("wants") },
          { label: "Future", value: c.future, color: palette("future") },
        ];
        drawPie(ctx, w, h, slices);
      }

      function renderAll() {
        renderBills(state.billsTemplate);
        renderAllLight();
        renderHistory();
      }

      function renderAllLight() {
        const c = calcFromInputs();
        const g = grade50_30_20(c.needsPct, c.wantsPct, c.futurePct);

        renderKpis(c, g);
        renderLegend(c);
        renderGrade(g);
        renderMessages(c);
        renderGoals(c);
        renderPie(c);
        renderMonthSavedIndicator();
      }

      // ---------- Save / Load ----------
      function saveCurrentMonth() {
        const month = monthInput.value;
        if (!month) { alert("Pick a month first."); return; }

        const c = calcFromInputs();
        const entry = /** @type {MonthEntry} */ ({
          month,
          income: c.income,
          bills: structuredClone(state.billsTemplate).map(b => ({...b, amount: num(b.amount)})),
          savings: c.savings,
          investing: c.investing,
          savingsGoalTarget: num(savingsGoalTarget.value),
          savingsGoalCurrent: num(savingsGoalCurrent.value),
          createdAt: Date.now()
        });

        const idx = state.history.findIndex(e => e.month === month);
        if (idx >= 0) state.history[idx] = entry;
        else state.history.push(entry);

        saveState();
        renderAllLight();
        renderHistory();
      }

      function loadSavedMonth() {
        const month = monthInput.value;
        if (!month) { alert("Pick a month first."); return; }
        const found = findHistory(month);
        if (!found) { alert("No saved entry for this month."); return; }

        // Load values
        incomeInput.value = String(num(found.income));
        savingsInput.value = String(num(found.savings));
        investInput.value = String(num(found.investing));
        savingsGoalTarget.value = String(num(found.savingsGoalTarget));
        savingsGoalCurrent.value = String(num(found.savingsGoalCurrent));

        // Load bills template from entry bills
        state.billsTemplate = structuredClone(found.bills || []);
        // Ensure bill IDs exist
        state.billsTemplate = state.billsTemplate.map(b => ({
          id: b.id || cryptoId(),
          name: b.name || "Bill",
          amount: num(b.amount)
        }));

        saveState();
        renderAll();
      }

      // ---------- Export / Import ----------
      function exportBackup() {
        const payload = {
          version: 1,
          exportedAt: new Date().toISOString(),
          data: state
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `finance-dashboard-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      async function importBackup(file) {
        const text = await file.text();
        let parsed;
        try {
          parsed = JSON.parse(text);
        } catch {
          alert("That file isn't valid JSON.");
          return;
        }

        const incoming = parsed?.data ?? parsed; // allow raw state too
        if (!incoming || typeof incoming !== "object") {
          alert("Backup file structure not recognized.");
          return;
        }
        if (!Array.isArray(incoming.history) || !Array.isArray(incoming.billsTemplate)) {
          alert("Backup file missing expected fields (history, billsTemplate).");
          return;
        }

        state = {
          billsTemplate: incoming.billsTemplate.map(b => ({
            id: b.id || cryptoId(),
            name: b.name || "Bill",
            amount: num(b.amount)
          })),
          history: incoming.history.map(e => ({
            month: String(e.month || ""),
            income: num(e.income),
            bills: (e.bills || []).map(b => ({
              id: b.id || cryptoId(),
              name: b.name || "Bill",
              amount: num(b.amount)
            })),
            savings: num(e.savings),
            investing: num(e.investing),
            savingsGoalTarget: num(e.savingsGoalTarget),
            savingsGoalCurrent: num(e.savingsGoalCurrent),
            createdAt: Number(e.createdAt) || Date.now()
          })).filter(e => /^\d{4}-\d{2}$/.test(e.month))
        };

        saveState();
        renderAll();
      }

      function deleteSelected() {
        const checks = historyBody.querySelectorAll('input[type="checkbox"][data-month]:checked');
        const months = [...checks].map(c => c.getAttribute("data-month")).filter(Boolean);
        if (months.length === 0) { alert("Select rows to delete."); return; }
        if (!confirm(`Delete ${months.length} month(s) from history?`)) return;

        state.history = state.history.filter(e => !months.includes(e.month));
        saveState();
        renderHistory();
        renderMonthSavedIndicator();
      }

      // ---------- Event wiring ----------
      function wire() {
        addBillBtn.addEventListener("click", addBill);

        [monthInput, incomeInput, savingsInput, investInput, savingsGoalTarget, savingsGoalCurrent].forEach(el => {
          el.addEventListener("input", () => {
            renderAllLight();
          });
          el.addEventListener("change", () => {
            renderAllLight();
          });
        });

        saveMonthBtn.addEventListener("click", saveCurrentMonth);
        loadMonthBtn.addEventListener("click", loadSavedMonth);
        exportBtn.addEventListener("click", exportBackup);

        importFile.addEventListener("change", async () => {
          const file = importFile.files?.[0];
          if (!file) return;
          await importBackup(file);
          importFile.value = "";
        });

        resetBtn.addEventListener("click", () => {
          if (!confirm("Reset local data on this browser? This cannot be undone unless you exported a backup.")) return;
          localStorage.removeItem(STORAGE_KEY);
          resetState();
        });

        deleteSelectedBtn.addEventListener("click", deleteSelected);

        // Quick sanity on storage availability
        try {
          localStorage.setItem("__test__", "1");
          localStorage.removeItem("__test__");
        } catch {
          storageBadge.textContent = "Local: BLOCKED";
          storageBadge.style.borderColor = "rgba(255,123,114,.35)";
          storageBadge.style.color = "rgba(255,123,114,.95)";
          storageBadge.style.background = "rgba(255,123,114,.08)";
        }
      }

      // ---------- Boot ----------
      initMonthToNow();
      ensureTemplate();
      renderAll();
      wire();
    })();
  </script>
</body>
</html>